# This file is @generated by <https://github.com/liblaf/copier-release>.
# DO NOT EDIT!

name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  release-please:
    name: Release Please
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-release-please
      cancel-in-progress: true
    outputs:
      created: ${{ steps.release-please.outputs.release_created }}
      pr: ${{ steps.release-please.outputs.pr }}
      tag: ${{ steps.release-please.outputs.tag_name }}
    steps:
      - id: auth
        name: Auth App
        uses: liblaf/actions/auth-app@main
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
      - id: release-please
        name: Release Please
        uses: googleapis/release-please-action@v4
        with:
          config-file: .config/release-please/config.json
          manifest-file: .config/release-please/.manifest.json
          token: ${{ steps.auth.outputs.token }}

  changelog-pr:
    name: Changelog (PR)
    permissions:
      contents: write
    needs:
      - release-please
    if: ${{ needs.release-please.outputs.pr }}
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-changelog-pr
      cancel-in-progress: true
    steps:
      - id: auth
        name: Auth App
        uses: liblaf/actions/auth-app@main
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ fromJson(needs.release-please.outputs.pr).headBranchName }}
          token: ${{ steps.auth.outputs.token }}
          fetch-depth: 0
      - id: tag
        name: Parse Tag
        run: |-
          title="${{ fromJson(needs.release-please.outputs.pr).title }}"
          version=$(echo "$title" | awk '{ print $NF }')
          echo "tag=v$version" >> "$GITHUB_OUTPUT"
      - name: Changelog
        uses: liblaf/actions/changelog@main
        with:
          args: --tag "${{ steps.tag.outputs.tag }}"
          output: CHANGELOG.md
      - name: Commit
        uses: liblaf/actions/commit@main
        with:
          add-options: --verbose "CHANGELOG.md"
          message: "chore(docs): update CHANGELOG.md"
          token: ${{ steps.auth.outputs.token }}

  changelog-release:
    name: Changelog (Release)
    permissions:
      actions: write
      contents: write
    needs:
      - release-please
    if: ${{ needs.release-please.outputs.created }}
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-changelog-release
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag }}
          fetch-depth: 0
      - id: changelog
        name: Changelog
        uses: liblaf/actions/changelog@main
        with:
          args: --current --strip all
      - name: Update Release
        run: gh release edit "${{ needs.release-please.outputs.tag }}" --notes-file "${{ steps.changelog.outputs.changelog }}"
        env:
          GH_TOKEN: ${{ github.token }}
