# This file is @generated by <https://github.com/liblaf/copier-typescript>.
# DO NOT EDIT!

name: Test

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

env:
  FORCE_COLOR: 1

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Install Dependencies
        run: |-
          bun ci
          bun pm bin >> "$GITHUB_PATH"
      - name: Build
        run: bun pm pack --destination 'pack'
      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: pack
          path: pack

  collect:
    name: Collect
    runs-on: ubuntu-latest
    outputs:
      has-tests: ${{ steps.collect.outputs.has-tests }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - id: collect
        name: Collect Tests
        run: |-
          if [[ -n "$(find '.' -name '*.test.ts' -type f)" ]]; then
            echo 'has-tests=true' >> "$GITHUB_OUTPUT"
          else
            echo 'has-tests=false' >> "$GITHUB_OUTPUT"
          fi

  test:
    name: Test
    permissions:
      id-token: write
    needs:
      - collect
    if: needs.collect.outputs.has-tests == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Install Dependencies
        run: |-
          bun ci
          bun pm bin >> "$GITHUB_PATH"
      - name: Run Tests
        run: >-
          bun test
          --coverage --coverage-reporter='text' --coverage-reporter='lcov'
          --reporter='junit' --reporter-outfile='junit.xml'
      - name: Upload Coverage
        uses: codecov/codecov-action@v5
        with:
          use_oidc: true
      - if: success() || failure()
        name: Upload Test Report
        uses: codecov/codecov-action@v5
        with:
          report_type: test_results
          use_oidc: true

  tsc:
    name: TypeScript Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Install Dependencies
        run: |-
          bun ci
          bun pm bin >> "$GITHUB_PATH"
      - name: TypeScript Check
        run: bun run tsc --pretty --noEmit
